name: Smoke

on:
  # Primary: run on PRs targeting main
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths:
      - '**'
  # Optional: allow manual runs (useful for testing)
  workflow_dispatch:

concurrency:
  # Cancel earlier runs for the same PR or same commit
  group: smoke-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  smoke:
    # NOTE: The job id IS the required check name (“smoke”)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Hit Production homepage
        run: |
          set -euo pipefail
          url="https://complianceloop.com"
          code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 20 "$url")
          echo "HTTP $code from $url"
          # Treat the site as UP unless it's a 5xx or totally unreachable (000)
          if [ "$code" -ge 500 ] || [ "$code" -eq 000 ]; then
            echo "Failing: received $code from $url"
            exit 22
          fi

      - name: Hit Preview redirect (www)
        run: |
          set -euo pipefail
          url="https://www.complianceloop.com"
          code=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 20 "$url")
          echo "HTTP $code from $url"
          if [ "$code" -ge 500 ] || [ "$code" -eq 000 ]; then
            echo "Failing: received $code from $url"
            exit 22
          fi

      # Add more targets here as you expose them publicly.
      # Keep them short and tolerant of transient hiccups.
