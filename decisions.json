{
  "meta": {
    "lastUpdatedBy": "CL Playbook",
    "lastUpdatedAt": "2025-09-26"
  },
  "authoringStandard": {
    "version": "1.0",
    "title": "Authoring Standard (MANDATORY)",
    "canonicalWording": [
      "Write instructions step-by-step with explicit UI clicks (e.g., “Vercel → Project → Settings → Security → Protection → Preview Deployments”).",
      "Include a direct, clickable URL for every external step (GitHub pages, Vercel settings, deployments, etc.).",
      "Provide copy-pasteable commands with clearly marked placeholders (e.g., <PASTE_URL>, <TEAM_ID>), and show Windows + macOS variants when relevant.",
      "Never print secrets; refer to them by secret name (e.g., VERCEL_TOKEN). If a token is needed, say where to create/copy it and where to store it.",
      "When editing repo files, provide full-file replacements (no “insert above/below line”). Also include the direct GitHub edit URL for that file.",
      "State success criteria and safe rollback steps for every procedure.",
      "If the UI can differ, include a brief “What you might see” note and the fallback path.",
      "Default tone: concise, kind, senior-developer practical."
    ]
  },
  "repositories": {
    "canonical": {
      "owner": "ComplianceLoop",
      "repo": "complianceloop-site",
      "defaultBranch": "main"
    }
  },
  "vercel": {
    "team": {
      "slug": "compliance-loop"
    },
    "projects": [
      {
        "name": "complianceloop-site",
        "role": "marketing/docs",
        "notes": "Original canonical project."
      },
      {
        "name": "complianceloop-portal",
        "role": "app/portal",
        "notes": "Phase-1 auth/db; used by CI smoke."
      }
    ],
    "preview": {
      "protection": "enabled",
      "bypassTokenSecretName": "VERCEL_BYPASS_TOKEN",
      "urlResolution": "CI queries Vercel /v6/deployments for READY deployment where meta.githubCommitRef == PR branch and app=complianceloop-portal; falls back to latest READY preview if no branch match."
    }
  },
  "automation": {
    "workflows": [
      {
        "path": ".github/workflows/agent-smoke.yml",
        "purpose": "Wait for Vercel Preview and run smoke test on each PR.",
        "inputs": {
          "env": {
            "VERCEL_APP": "complianceloop-portal"
          },
          "secrets": [
            "VERCEL_TOKEN",
            "VERCEL_TEAM_ID",
            "VERCEL_BYPASS_TOKEN (required when preview protection is enabled)"
          ]
        },
        "successCriteria": [
          "Workflow prints preview URL.",
          "Smoke script prints 'Root page probe passed.' and '✅ smoke passed.'"
        ],
        "safeRollback": [
          "Disable or remove the workflow file.",
          "Promote a prior READY deployment in Vercel if needed."
        ]
      },
      {
        "path": ".github/workflows/design-skin-kit.yml",
        "purpose": "Add theme tokens, global styles, /design-playground",
        "successCriteria": [
          "Preview builds green; /design-playground renders"
        ],
        "safeRollback": [
          "Revert PR"
        ]
      },
      {
        "path": ".github/workflows/phase-1-auth-db.yml",
        "purpose": "Neon + Drizzle schema; passwordless auth APIs",
        "successCriteria": [
          "Preview endpoints /api/auth/* return 200"
        ],
        "safeRollback": [
          "Revert PR"
        ]
      },
      {
        "path": ".github/workflows/phase-2-files-r2.yml",
        "purpose": "Private file uploads to R2; secure streaming via /api/files/[...key]",
        "successCriteria": [
          "Upload returns key; signed-in download streams 200"
        ],
        "safeRollback": [
          "Revert PR"
        ]
      },
      {
        "path": ".github/workflows/seed-phase-1.yml",
        "purpose": "Optional seed of demo customer/jobs",
        "successCriteria": [
          "Seed script completes"
        ],
        "safeRollback": [
          "Re-run with corrected env or revert"
        ]
      },
      {
        "path": ".github/workflows/update-allowlist.yml",
        "purpose": "Maintain preview allowlist/protection bypass as needed",
        "successCriteria": [
          "Protected previews accessible to CI; prod unaffected"
        ],
        "safeRollback": [
          "Revert PR; rotate bypass token if leaked"
        ]
      }
    ]
  },
  "operationalNotes": [
    "On 2025-09-25 the Agent Smoke workflow succeeded for PR #21 (feat/phase-1-auth-db) after updating the project-specific Vercel Protection Bypass token in repo secret VERCEL_BYPASS_TOKEN.",
    "Preview URLs are dynamic per deployment; CI resolves at runtime.",
    "Repo root currently does not require Node deps to run smoke; Node 20+ is sufficient.",
    "If CI logs show 401 at bypass, update VERCEL_BYPASS_TOKEN with the exact token from the project’s Security → Protection → Preview Deployments."
  ],
  "quickLinks": {
    "githubActions": "https://github.com/ComplianceLoop/complianceloop-site/actions",
    "githubSecrets": "https://github.com/ComplianceLoop/complianceloop-site/settings/secrets/actions",
    "vercelTokens": "https://vercel.com/account/tokens",
    "vercelTeamSettings": "https://vercel.com/teams/compliance-loop/settings",
    "vercelProjectSecurity": "https://vercel.com/compliance-loop/complianceloop-portal/settings/security",
    "vercelProjectGit": "https://vercel.com/compliance-loop/complianceloop-portal/settings/git",
    "vercelDeployments": "https://vercel.com/compliance-loop/complianceloop-portal/deployments",
    "workflowEdit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/.github/workflows/agent-smoke.yml",
    "playbookEdit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/playbook.md",
    "decisionsEdit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/decisions.json"
  },
  "workflows": [
    {
      "path": ".github/workflows/agent-smoke.yml",
      "purpose": "Wait for Vercel Preview and run smoke test on each PR.",
      "inputs": {
        "env": {
          "VERCEL_APP": "complianceloop-portal"
        },
        "secrets": [
          "VERCEL_TOKEN",
          "VERCEL_TEAM_ID",
          "VERCEL_BYPASS_TOKEN (required when preview protection is enabled)"
        ]
      },
      "successCriteria": [
        "Workflow prints preview URL.",
        "Smoke script prints 'Root page probe passed.' and '✅ smoke passed.'"
      ],
      "safeRollback": [
        "Disable or remove the workflow file.",
        "Promote a prior READY deployment in Vercel if needed."
      ]
    },
    {
      "path": ".github/workflows/design-skin-kit.yml",
      "purpose": "Add theme tokens, global styles, /design-playground",
      "successCriteria": [
        "Preview builds green; /design-playground renders"
      ],
      "safeRollback": [
        "Revert PR"
      ]
    },
    {
      "path": ".github/workflows/phase-1-auth-db.yml",
      "purpose": "Neon + Drizzle schema; passwordless auth APIs",
      "successCriteria": [
        "Preview endpoints /api/auth/* return 200"
      ],
      "safeRollback": [
        "Revert PR"
      ]
    },
    {
      "path": ".github/workflows/phase-2-files-r2.yml",
      "purpose": "Private file uploads to R2; secure streaming via /api/files/[...key]",
      "successCriteria": [
        "Upload returns key; signed-in download streams 200"
      ],
      "safeRollback": [
        "Revert PR"
      ]
    },
    {
      "path": ".github/workflows/seed-phase-1.yml",
      "purpose": "Optional seed of demo customer/jobs",
      "successCriteria": [
        "Seed script completes"
      ],
      "safeRollback": [
        "Re-run with corrected env or revert"
      ]
    },
    {
      "path": ".github/workflows/update-allowlist.yml",
      "purpose": "Maintain preview allowlist/protection bypass as needed",
      "successCriteria": [
        "Protected previews accessible to CI; prod unaffected"
      ],
      "safeRollback": [
        "Revert PR; rotate bypass token if leaked"
      ]
    }
  ],
  "phases": [
    "Admin console",
    "Airtable bridge (hybrid)",
    "Assignment engine (first-accept, soft-hold cascade, single-eligible auto-assign)",
    "Auth + DB base",
    "Customer dashboard",
    "Design Skin Kit",
    "Files & Certificates (R2)",
    "Job model + booking skeleton",
    "Notifications (email/SMS)",
    "Payments & invoices",
    "Polish & launch (SEO, A11y, QA, rate limits)",
    "Provider dashboard (+ day-of checklist, conflict)",
    "Provider directory & eligibility"
  ]
}
