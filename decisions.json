{
  "version": "2025-09-28.1",
  "currentPhase": "Files & Certificates (R2)",
  "phases": [
    {
      "phase": "Design Skin Kit",
      "objective": "Theme tokens, brand, and UI primitives to speed all later pages.",
      "deliverables": ["theme.ts tokens", "globals.css", "Button/Input/Card", "/design-playground"],
      "acceptance": ["Preview renders", "Tokens adjustable with hot reload"],
      "status": "landed",
      "landedAt": "2025-09-27"
    },
    {
      "phase": "Auth + DB base",
      "objective": "Neon + Drizzle schema, passwordless email code, sessions.",
      "deliverables": ["/api/auth/send-code", "/api/auth/verify-code", "users, sessions tables"],
      "acceptance": ["Vercel env DATABASE_URL set", "Auth code roundtrip works", "Dashboard gate honors session"],
      "status": "landed",
      "landedAt": "2025-09-26",
      "verification": ["DATABASE_URL set", "send-code 200", "verify-code 200 (session issued)"]
    },
    {
      "phase": "Files & Certificates (R2)",
      "objective": "Private file storage with signed streaming.",
      "deliverables": ["/api/files/upload", "/api/files/:key", "R2 bucket + IAM"],
      "acceptance": ["Upload from provider portal → 200 r2Key", "Authorized GET streams; unauthorized 403"],
      "status": "in_progress",
      "startedAt": "2025-09-27"
    },
    {
      "phase": "Airtable bridge (hybrid)",
      "objective": "Mirror critical records for ops; Neon remains source of record.",
      "deliverables": ["sync script, cron", "idempotent mapping"],
      "acceptance": ["One-way sync green in CI", "Backfill job OK"]
    },
    {
      "phase": "Job model + booking skeleton",
      "objective": "Booking wizard + soft hold creation.",
      "deliverables": ["/book wizard", "create Job(draft) API", "Soft-hold service"],
      "acceptance": ["30m hold for multi-property", "Single-property flow ok"]
    },
    {
      "phase": "Provider directory & eligibility",
      "objective": "Eligibility rules + instant decision.",
      "deliverables": ["criteria engine", "provider onboarding form", "How-to-qualify guidance"],
      "acceptance": ["Pass/fail immediate", "Declined path shows guidance"]
    },
    {
      "phase": "Assignment engine",
      "objective": "First-accept wins + 15m soft-hold + single-eligible auto-assign.",
      "deliverables": ["offer broadcast", "accept endpoint", "cascade logic"],
      "acceptance": ["Race handled; winner locks; cascade on timeout/decline"]
    },
    {
      "phase": "Customer dashboard",
      "objective": "List past/upcoming jobs + files/invoices.",
      "deliverables": ["dashboard pages", "job detail route"],
      "acceptance": ["Auth required", "Documents stream correctly"]
    },
    {
      "phase": "Provider dashboard",
      "objective": "Job queue + day-of checklist + conflict report + tech email routing.",
      "deliverables": ["checklist form", "conflict endpoint", "email routing field"],
      "acceptance": ["Late submission possible", "Conflict auto-cascade"]
    },
    {
      "phase": "Payments & invoices",
      "objective": "Invoice links and settlement (minimal MVP).",
      "deliverables": ["invoice record", "link on job page"],
      "acceptance": ["Invoices viewable; payments later (toggle)"]
    },
    {
      "phase": "Notifications (email/SMS)",
      "objective": "Resend email events; SMS optional later.",
      "deliverables": ["templates", "event triggers"],
      "acceptance": ["Email on accept, conflict, ready-to-download"]
    },
    {
      "phase": "Admin console",
      "objective": "Search jobs/providers; manual override tools.",
      "deliverables": ["admin routes", "impersonate (guarded)"],
      "acceptance": ["Admin-only gate", "Audit trail"]
    },
    {
      "phase": "Polish & launch",
      "objective": "SEO, a11y, rate limits, QA.",
      "deliverables": ["schema.org Business markup", "robots, sitemaps", "basic rate limiting"],
      "acceptance": ["Lighthouse ≥90", "No PII leaks", "Runbook updated"]
    }
  ],
  "phaseProgress": {
    "Files & Certificates (R2)": {
      "tasks": [
        { "id": "r2-signer", "title": "lib/r2-signer.ts", "status": "pending" },
        { "id": "upload-route", "title": "POST /api/files/upload", "status": "pending" },
        { "id": "get-route", "title": "GET /api/files/[key]", "status": "pending" },
        { "id": "verify", "title": "Verification: 200 on upload, authorized stream 200, unauth 403", "status": "pending" }
      ]
    }
  ],
  "finances": {
    "currency": "USD",
    "oneTime": {
      "items": [
        { "date": "2025-09-26", "label": "New laptop", "amount": 175, "notes": "", "source": "user" },
        { "date": "2025-08-23", "label": "Connecticut LLC filing fee", "amount": 120, "notes": "", "source": "user" },
        { "date": "2025-09-26", "label": "Chat GPT credits", "amount": 100, "notes": "", "source": "user" }
      ],
      "total": 395
    },
    "subscriptions": {
      "items": [
        { "label": "ChatGPT Business", "plan": "Business", "billingInterval": "monthly", "amount": 60, "status": "active", "notes": "" },
        { "label": "Vercel Pro Plan", "plan": "Pro", "billingInterval": "monthly", "amount": 20, "status": "active", "notes": "" },
        { "label": "GitHub Base Plan", "plan": "Free", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Porkbun", "plan": "Domain", "billingInterval": "annual", "amount": 11.08, "status": "active", "notes": "" },
        { "label": "Cal.com", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "not_set_up", "notes": "" },
        { "label": "Make", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Stripe", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "not_set_up", "notes": "" },
        { "label": "Airtable", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Google Workspace", "plan": "", "billingInterval": "monthly", "amount": 39.60, "status": "active", "notes": "" }
      ],
      "monthlyTotal": 119.6,
      "annualOnlyTotal": 11.08,
      "arr": 1446.28
    },
    "lastUpdated": "2025-09-26"
  },
  "links": {
    "editDecisions": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/decisions.json",
    "editPlaybook": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/playbook.md",
    "runReconciler": "https://github.com/ComplianceLoop/complianceloop-site/actions/workflows/reconcile-decisions-and-playbook.yml",
    "pulls": "https://github.com/ComplianceLoop/complianceloop-site/pulls",
    "vercelEnv": "https://vercel.com/compliance-loop/complianceloop-portal/settings/environment-variables",
    "vercelDeployments": "https://vercel.com/compliance-loop/complianceloop-portal/deployments"
  },
  "fileActions": {
    "policy": "Use EDIT links if file exists; otherwise use CREATE links.",
    "items": [
      {
        "path": "lib/r2-signer.ts",
        "exists": false,
        "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/lib/r2-signer.ts",
        "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=lib%2Fr2-signer.ts",
        "purpose": "AWS SigV4 presign/sign helper (no deps)",
        "lastChecked": "2025-09-28"
      },
      {
        "path": "app/api/files/upload/route.ts",
        "exists": false,
        "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/app/api/files/upload/route.ts",
        "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=app%2Fapi%2Ffiles%2Fupload%2Froute.ts",
        "purpose": "POST → presigned PUT URL + r2Key",
        "lastChecked": "2025-09-28"
      },
      {
        "path": "app/api/files/%5Bkey%5D/route.ts",
        "exists": false,
        "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/app/api/files/%5Bkey%5D/route.ts",
        "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=app%2Fapi%2Ffiles%2F%5Bkey%5D%2Froute.ts",
        "purpose": "GET → authorized stream from R2",
        "lastChecked": "2025-09-28"
      }
    ]
  },
  "operationalNotes": {
    "reconcilerProcess": {
      "summary": "Run the Reconciler once after edits. If the Playbook block is stuck or workflow says 'no changes to commit', reset playbook.md then run once.",
      "normalRun": {
        "commitTitle": "finances: add expenses + subscriptions and tallies; preserve phases",
        "steps": [
          "Open links.editDecisions",
          "Paste full-file decisions.json and Commit changes with commitTitle",
          "Open links.runReconciler and Run workflow",
          "Open links.pulls, open the PR, Merge pull request, Confirm merge"
        ]
      },
      "resetRun": {
        "when": "Only if previous runs show no changes to commit or the Playbook block is stale.",
        "steps": [
          "Open links.editDecisions, paste full-file decisions.json, Commit changes",
          "Open links.editPlaybook, replace with '<!-- CL:START -->\\n<!-- CL:END -->', Commit with 'playbook: reset generated block'",
          "Open links.runReconciler and Run workflow",
          "Open links.pulls, open the PR, Merge pull request, Confirm merge"
        ]
      }
    },
    "r2Env": {
      "note": "Set env vars in Vercel; store no secrets in repo.",
      "vars": ["R2_ACCOUNT_ID", "R2_REGION", "R2_ACCESS_KEY_ID", "R2_SECRET_ACCESS_KEY", "R2_BUCKET"]
    },
    "moduleResolution.playbook": [
      "Avoid imports like '@/app/../…'. Prefer '@/lib/*' and '@/db/*', or stable relative paths.",
      "When API routes under app/api/** error on imports, switch to **relative** imports targeting root shims (e.g., '../../../../lib/db').",
      "Root shims mapping to apps/portal code: lib/db.ts, db/schema.ts, lib/auth.ts."
    ],
    "tailwind.setup": [
      "Install tailwindcss, postcss, autoprefixer as **dependencies** in both root/package.json and apps/portal/package.json.",
      "apps/portal/postcss.config.js: { plugins: { tailwindcss: {}, autoprefixer: {} } }",
      "apps/portal/tailwind.config.ts content globs include portal and shared roots.",
      "apps/portal/styles/globals.css must start with Tailwind directives.",
      "apps/portal/app/layout.tsx must import '../styles/globals.css'."
    ],
    "designPlayground": [
      "Single source at app/design-playground/page.tsx.",
      "Use lowercase component filenames and relative imports.",
      "Ensure no duplicate under apps/portal/app/…; do not recreate .github/workflows/design-skin-kit.yml."
    ],
    "vercel.deploy": [
      "When debugging builds, redeploy with 'Use existing Build Cache' unchecked.",
      "If 'Cannot find module tailwindcss', ensure Tailwind/PostCSS/Autoprefixer exist in dependencies at both root and apps/portal."
    ],
    "assistant.houseStyle": {
      "musts": [
        "Always provide full-file replacements for code/workflows. No snippets.",
        "For each file, show EDIT and (if applicable) CREATE link immediately above the steps.",
        "Numbered, click-by-click steps.",
        "Include a short commit title.",
        "Include a 'Verify' checklist with exact URLs/cURL and expected statuses.",
        "Do not re-open landed phases; respect currentPhase and phases[].status."
      ],
      "antiPatterns": [
        "Do not invent files under apps/portal/app if the source of truth is root app/…",
        "Do not change Design Skin once landed unless explicitly asked."
      ]
    }
  },
  "checklists": {
    "prePhase3-ready": [
      "✅ Production deployment is green in Vercel (no-cache redeploy verified).",
      "✅ app/design-playground/page.tsx uses relative, lowercase imports.",
      "✅ Duplicate design-playground page removed under apps/portal/app/…",
      "✅ .github/workflows/design-skin-kit.yml removed.",
      "✅ Root shims exist: lib/db.ts, db/schema.ts, lib/auth.ts.",
      "✅ Tailwind configured in root and apps/portal; configs present; globals.css has directives; layout imports it.",
      "✅ Vercel env vars (R2) present."
    ]
  },
  "accomplishments": [
    "Resolved module resolution errors via stable imports and root shims.",
    "Normalized design playground; removed duplicate generator workflow.",
    "Installed and configured Tailwind for apps/portal; builds green.",
    "Successful production redeploy without cache."
  ],
  "status": { "playbookGeneratedAt": null, "lastReconciledAt": null },
  "handoff": {
    "purpose": "Allow any assistant/chat to resume seamlessly.",
    "repo": { "owner": "ComplianceLoop", "name": "complianceloop-site", "branch": "main" },
    "vercel": { "team": "ComplianceLoop", "project": "complianceloop-portal" },
    "expectations": [
      "Fetch BOTH raw files (decisions.json, playbook.md) before acting.",
      "Decisions live only in decisions.json; the Playbook CL block is generated.",
      "Never store secrets; refer by name only."
    ],
    "successCriteria": [
      "Reconciler PR opens from the latest decisions.json.",
      "Playbook block regenerates to match decisions.json.",
      "No manual edits inside <!-- CL:START --> … <!-- CL:END -->."
    ],
    "safeRollback": [
      "Revert the last decisions.json commit on main.",
      "Reset playbook.md to only the CL block if needed and re-run the Reconciler."
    ],
    "prompt": "SYNC FROM REPO — ComplianceLoop (MANDATORY)\\n\\nSingle source of truth\\n- decisions.json (raw): https://raw.githubusercontent.com/ComplianceLoop/complianceloop-site/main/decisions.json\\n- playbook.md (raw): https://raw.githubusercontent.com/ComplianceLoop/complianceloop-site/main/playbook.md\\n\\nDirect edit / run links\\n- Edit decisions.json: https://github.com/ComplianceLoop/complianceloop-site/edit/main/decisions.json\\n- Reconciler workflow (Run): https://github.com/ComplianceLoop/complianceloop-site/actions/workflows/reconcile-decisions-and-playbook.yml\\n- Pull requests: https://github.com/ComplianceLoop/complianceloop-site/pulls\\n- Vercel deployments: https://vercel.com/compliance-loop/complianceloop-portal/deployments\\n- Vercel environment variables: https://vercel.com/compliance-loop/complianceloop-portal/settings/environment-variables\\n\\nRepo & project context\\n- Repo: ComplianceLoop/complianceloop-site (branch: main)\\n- Vercel project: complianceloop-portal (team: ComplianceLoop)\\n\\nHOUSE STYLE (MANDATORY)\\n- Always: full-file code replacements, numbered click-by-click steps, commit title, EDIT/CREATE links above steps, Verify checklist with URLs/cURL and expected statuses.\\n- Respect currentPhase in decisions.json and phases[].status; do NOT reopen landed phases.\\n\\nTROUBLESHOOTING GOTCHAS\\n- Imports: avoid '@/app/../…'. Prefer '@/lib/*', '@/db/*', or stable relative paths. Root shims allowed.\\n- Tailwind: tailwindcss/postcss/autoprefixer must be dependencies in both root and apps/portal package.json. apps/portal has postcss.config.js + tailwind.config.ts; globals.css starts with tailwind directives; layout imports it.\\n- Design Playground: only app/design-playground/page.tsx (lowercase/relative).\\n\\nYOUR JOB\\n- Read decisions.json → use currentPhase + phaseProgress to pick up work.\\n- Produce the exact steps and full files to complete remaining tasks in the current phase.\\n- After commits, ask me to redeploy (no cache) and verify acceptance; then mark progress back into decisions.json and have me run the Reconciler once."
  },
  "agentPromptTemplate": "You are the ComplianceLoop Playbook Agent. Implement the current phase using fileActions and phaseProgress. Follow HOUSE STYLE strictly. Never write secrets to the repo. Use Vercel env for secrets. Avoid '@/app/../*' imports; prefer '@/lib/*' or stable relative paths. Ensure Tailwind is installed in both root and apps/portal; apps/portal has postcss.config.js, tailwind.config.ts, and globals.css with Tailwind directives, imported from layout. Redeploy with cache disabled when debugging. Success: green build, endpoints/pages live, acceptance in decisions.json verified."
}
