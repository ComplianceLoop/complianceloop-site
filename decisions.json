{
  "version": "2025-09-28.9",
  "currentPhase": "Files & Certificates (R2)",
  "phases": [
    {
      "phase": "Design Skin Kit",
      "objective": "Theme tokens, brand, and UI primitives to speed all later pages.",
      "deliverables": ["theme.ts tokens", "globals.css", "Button/Input/Card", "/design-playground"],
      "acceptance": ["Preview renders", "Tokens adjustable with hot reload"],
      "status": "landed",
      "landedAt": "2025-09-27"
    },
    {
      "phase": "Auth + DB base",
      "objective": "Neon and Drizzle schema, passwordless email code, sessions.",
      "deliverables": ["/api/auth/send-code", "/api/auth/verify-code", "users and sessions tables"],
      "acceptance": ["Vercel env DATABASE_URL set", "Auth code roundtrip works", "Dashboard gate honors session"],
      "status": "landed",
      "landedAt": "2025-09-26",
      "verification": ["DATABASE_URL set", "send-code 200", "verify-code 200 (session issued)"]
    },
    {
      "phase": "Files & Certificates (R2)",
      "objective": "Private file storage with signed streaming.",
      "deliverables": ["/api/files/upload", "/api/files/:key", "R2 bucket and IAM"],
      "acceptance": ["Upload returns 200 and r2Key", "Authorized GET streams 200; unauthorized 403"],
      "status": "in_progress",
      "startedAt": "2025-09-27"
    },
    {
      "phase": "Airtable bridge (hybrid)",
      "objective": "Mirror critical records for ops; Neon remains source of record.",
      "deliverables": ["sync script", "cron", "idempotent mapping"],
      "acceptance": ["One-way sync green in CI", "Backfill job OK"]
    },
    {
      "phase": "Job model + booking skeleton",
      "objective": "Booking wizard and soft hold creation.",
      "deliverables": ["/book wizard", "create Job draft API", "Soft-hold service"],
      "acceptance": ["30m hold for multi property", "Single property flow ok"]
    },
    {
      "phase": "Provider directory & eligibility",
      "objective": "Eligibility rules and instant decision.",
      "deliverables": ["criteria engine", "provider onboarding form", "how to qualify guidance"],
      "acceptance": ["Pass or fail immediate", "Declined path shows guidance"]
    },
    {
      "phase": "Assignment engine",
      "objective": "First accept wins with 15m soft hold and single eligible auto assign.",
      "deliverables": ["offer broadcast", "accept endpoint", "cascade logic"],
      "acceptance": ["Race handled; winner locks; cascade on timeout or decline"]
    },
    {
      "phase": "Customer dashboard",
      "objective": "List past and upcoming jobs plus files and invoices.",
      "deliverables": ["dashboard pages", "job detail route"],
      "acceptance": ["Auth required", "Documents stream correctly"]
    },
    {
      "phase": "Provider dashboard",
      "objective": "Job queue, day of checklist, conflict report, tech email routing.",
      "deliverables": ["checklist form", "conflict endpoint", "email routing field"],
      "acceptance": ["Late submission possible", "Conflict auto cascade"]
    },
    {
      "phase": "Payments & invoices",
      "objective": "Invoice links and settlement minimal MVP.",
      "deliverables": ["invoice record", "link on job page"],
      "acceptance": ["Invoices viewable; payments later via toggle"]
    },
    {
      "phase": "Notifications (email/SMS)",
      "objective": "Resend email events; SMS optional later.",
      "deliverables": ["templates", "event triggers"],
      "acceptance": ["Email on accept, conflict, ready to download"]
    },
    {
      "phase": "Admin console",
      "objective": "Search jobs and providers; manual override tools.",
      "deliverables": ["admin routes", "impersonate guarded"],
      "acceptance": ["Admin only gate", "Audit trail"]
    },
    {
      "phase": "Polish & launch",
      "objective": "SEO, accessibility, rate limits, QA.",
      "deliverables": ["schema.org business markup", "robots", "sitemaps", "basic rate limiting"],
      "acceptance": ["Lighthouse at least 90", "No PII leaks", "Runbook updated"]
    }
  ],
  "phaseProgress": {
    "Files & Certificates (R2)": {
      "tasks": [
        { "id": "r2-signer", "title": "lib/r2-signer.ts", "status": "pending" },
        { "id": "upload-route", "title": "POST /api/files/upload", "status": "pending" },
        { "id": "get-route", "title": "GET /api/files/[key]", "status": "pending" },
        { "id": "verify", "title": "Verify: upload 200; auth GET 200; unauth 403", "status": "pending" }
      ]
    }
  },
  "finances": {
    "currency": "USD",
    "oneTime": {
      "items": [
        { "date": "2025-09-26", "label": "New laptop", "amount": 175, "notes": "", "source": "user" },
        { "date": "2025-08-23", "label": "Connecticut LLC filing fee", "amount": 120, "notes": "", "source": "user" },
        { "date": "2025-09-26", "label": "Chat GPT credits", "amount": 100, "notes": "", "source": "user" }
      ],
      "total": 395
    },
    "subscriptions": {
      "items": [
        { "label": "ChatGPT Business", "plan": "Business", "billingInterval": "monthly", "amount": 60, "status": "active", "notes": "" },
        { "label": "Vercel Pro Plan", "plan": "Pro", "billingInterval": "monthly", "amount": 20, "status": "active", "notes": "" },
        { "label": "GitHub Base Plan", "plan": "Free", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Porkbun", "plan": "Domain", "billingInterval": "annual", "amount": 11.08, "status": "active", "notes": "" },
        { "label": "Cal.com", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "not_set_up", "notes": "" },
        { "label": "Make", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Stripe", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "not_set_up", "notes": "" },
        { "label": "Airtable", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Google Workspace", "plan": "", "billingInterval": "monthly", "amount": 39.6, "status": "active", "notes": "" }
      ],
      "monthlyTotal": 119.6,
      "annualOnlyTotal": 11.08,
      "arr": 1446.28
    },
    "lastUpdated": "2025-09-26"
  },
  "links": {
    "editDecisions": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/decisions.json",
    "editPlaybook": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/playbook.md",
    "runReconciler": "https://github.com/ComplianceLoop/complianceloop-site/actions/workflows/reconcile-decisions-and-playbook.yml",
    "pulls": "https://github.com/ComplianceLoop/complianceloop-site/pulls",
    "vercelEnv": "https://vercel.com/compliance-loop/complianceloop-portal/settings/environment-variables",
    "vercelDeployments": "https://vercel.com/compliance-loop/complianceloop-portal/deployments"
  },
  "fileActions": {
    "policy": "Use EDIT links if file exists; otherwise use CREATE links.",
    "items": [
      {
        "path": "lib/r2-signer.ts",
        "exists": false,
        "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/lib/r2-signer.ts",
        "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=lib%2Fr2-signer.ts",
        "purpose": "AWS SigV4 presign helper without extra deps",
        "lastChecked": "2025-09-28"
      },
      {
        "path": "app/api/files/upload/route.ts",
        "exists": false,
        "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/app/api/files/upload/route.ts",
        "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=app%2Fapi%2Ffiles%2Fupload%2Froute.ts",
        "purpose": "POST returns r2Key and presigned PUT URL",
        "lastChecked": "2025-09-28"
      },
      {
        "path": "app/api/files/%5Bkey%5D/route.ts",
        "exists": false,
        "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/app/api/files/%5Bkey%5D/route.ts",
        "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=app%2Fapi%2Ffiles%2F%5Bkey%5D%2Froute.ts",
        "purpose": "GET streams from R2 after auth",
        "lastChecked": "2025-09-28"
      }
    ]
  },
  "operationalNotes": {
    "reconcilerProcess": {
      "summary": "Run once after edits. If Playbook block is stale or it says no changes, reset playbook.md then run once.",
      "normalRun": {
        "commitTitle": "playbook: sync decisions",
        "steps": [
          "Open links.runReconciler and run it",
          "Open links.pulls and merge the PR it opens"
        ]
      },
      "resetRun": {
        "when": "Only if prior runs report no changes or the block is stale.",
        "steps": [
          "Open links.editPlaybook and replace with '<!-- CL:START -->\\n<!-- CL:END -->' then commit with 'playbook: reset generated block'",
          "Open links.runReconciler and run it",
          "Open links.pulls and merge the PR it opens"
        ]
      }
    },
    "r2Env": {
      "note": "Set env vars only in Vercel; never commit secrets.",
      "vars": ["R2_ACCOUNT_ID", "R2_REGION", "R2_ACCESS_KEY_ID", "R2_SECRET_ACCESS_KEY", "R2_BUCKET"]
    }
  },
  "status": { "playbookGeneratedAt": null, "lastReconciledAt": null },
  "handoff": {
    "promptPath": "handoff/prompt.md",
    "repo": { "owner": "ComplianceLoop", "name": "complianceloop-site", "branch": "main" },
    "vercel": { "team": "ComplianceLoop", "project": "complianceloop-portal" }
  }
}
