{
  "version": "2025-09-27.3",
  "phases": [
    {
      "phase": "Design Skin Kit",
      "objective": "Theme tokens, brand, and UI primitives to speed all later pages.",
      "deliverables": ["theme.ts tokens", "globals.css", "Button/Input/Card", "/design-playground"],
      "acceptance": ["Preview renders", "Tokens adjustable with hot reload"],
      "status": "landed",
      "landedAt": "2025-09-27"
    },
    {
      "phase": "Auth + DB base",
      "objective": "Neon + Drizzle schema, passwordless email code, sessions.",
      "deliverables": ["/api/auth/send-code", "/api/auth/verify-code", "users, sessions tables"],
      "acceptance": ["Vercel env DATABASE_URL set", "Auth code roundtrip works", "Dashboard gate honors session"],
      "status": "landed",
      "landedAt": "2025-09-26",
      "verification": ["DATABASE_URL set", "send-code 200", "verify-code 200 (session issued)"]
    },
    {
      "phase": "Files & Certificates (R2)",
      "objective": "Private file storage with signed streaming.",
      "deliverables": ["/api/files/upload", "/api/files/:key", "R2 bucket + IAM"],
      "acceptance": ["Upload from provider portal → 200 r2Key", "Authorized GET streams; unauthorized 403"],
      "status": "in_progress",
      "startedAt": "2025-09-27"
    },
    {
      "phase": "Airtable bridge (hybrid)",
      "objective": "Mirror critical records for ops; Neon remains source of record.",
      "deliverables": ["sync script, cron", "idempotent mapping"],
      "acceptance": ["One-way sync green in CI", "Backfill job OK"]
    },
    {
      "phase": "Job model + booking skeleton",
      "objective": "Booking wizard + soft hold creation.",
      "deliverables": ["/book wizard", "create Job(draft) API", "Soft-hold service"],
      "acceptance": ["30m hold for multi-property", "Single-property flow ok"]
    },
    {
      "phase": "Provider directory & eligibility",
      "objective": "Eligibility rules + instant decision.",
      "deliverables": ["criteria engine", "provider onboarding form", "How-to-qualify guidance"],
      "acceptance": ["Pass/fail immediate", "Declined path shows guidance"]
    },
    {
      "phase": "Assignment engine",
      "objective": "First-accept wins + 15m soft-hold + single-eligible auto-assign.",
      "deliverables": ["offer broadcast", "accept endpoint", "cascade logic"],
      "acceptance": ["Race handled; winner locks; cascade on timeout/decline"]
    },
    {
      "phase": "Customer dashboard",
      "objective": "List past/upcoming jobs + files/invoices.",
      "deliverables": ["dashboard pages", "job detail route"],
      "acceptance": ["Auth required", "Documents stream correctly"]
    },
    {
      "phase": "Provider dashboard",
      "objective": "Job queue + day-of checklist + conflict report + tech email routing.",
      "deliverables": ["checklist form", "conflict endpoint", "email routing field"],
      "acceptance": ["Late submission possible", "Conflict auto-cascade"]
    },
    {
      "phase": "Payments & invoices",
      "objective": "Invoice links and settlement (minimal MVP).",
      "deliverables": ["invoice record", "link on job page"],
      "acceptance": ["Invoices viewable; payments later (toggle)"]
    },
    {
      "phase": "Notifications (email/SMS)",
      "objective": "Resend email events; SMS optional later.",
      "deliverables": ["templates", "event triggers"],
      "acceptance": ["Email on accept, conflict, ready-to-download"]
    },
    {
      "phase": "Admin console",
      "objective": "Search jobs/providers; manual override tools.",
      "deliverables": ["admin routes", "impersonate (guarded)"],
      "acceptance": ["Admin-only gate", "Audit trail"]
    },
    {
      "phase": "Polish & launch",
      "objective": "SEO, a11y, rate limits, QA.",
      "deliverables": ["schema.org Business markup", "robots, sitemaps", "basic rate limiting"],
      "acceptance": ["Lighthouse ≥90", "No PII leaks", "Runbook updated"]
    }
  ],
  "finances": {
    "currency": "USD",
    "oneTime": {
      "items": [
        { "date": "2025-09-26", "label": "New laptop", "amount": 175, "notes": "", "source": "user" },
        { "date": "2025-08-23", "label": "Connecticut LLC filing fee", "amount": 120, "notes": "", "source": "user" },
        { "date": "2025-09-26", "label": "Chat GPT credits", "amount": 100, "notes": "", "source": "user" }
      ],
      "total": 395
    },
    "subscriptions": {
      "items": [
        { "label": "ChatGPT Business", "plan": "Business", "billingInterval": "monthly", "amount": 60, "status": "active", "notes": "" },
        { "label": "Vercel Pro Plan", "plan": "Pro", "billingInterval": "monthly", "amount": 20, "status": "active", "notes": "" },
        { "label": "GitHub Base Plan", "plan": "Free", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Porkbun", "plan": "Domain", "billingInterval": "annual", "amount": 11.08, "status": "active", "notes": "" },
        { "label": "Cal.com", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "not_set_up", "notes": "" },
        { "label": "Make", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Stripe", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "not_set_up", "notes": "" },
        { "label": "Airtable", "plan": "", "billingInterval": "monthly", "amount": 0, "status": "active", "notes": "" },
        { "label": "Google Workspace", "plan": "", "billingInterval": "monthly", "amount": 39.60, "status": "active", "notes": "" }
      ],
      "monthlyTotal": 119.6,
      "annualOnlyTotal": 11.08,
      "arr": 1446.28
    },
    "lastUpdated": "2025-09-26"
  },
  "links": {
    "editDecisions": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/decisions.json",
    "editPlaybook": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/playbook.md",
    "runReconciler": "https://github.com/ComplianceLoop/complianceloop-site/actions/workflows/reconcile-decisions-and-playbook.yml",
    "pulls": "https://github.com/ComplianceLoop/complianceloop-site/pulls",
    "vercelEnv": "https://vercel.com/compliance-loop/complianceloop-portal/settings/environment-variables"
  },
  "fileActions": {
    "policy": "Use EDIT links if file exists; otherwise use CREATE links.",
    "items": [
      { "path": "app/api/files/upload/route.ts", "exists": false, "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/app/api/files/upload/route.ts", "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=app%2Fapi%2Ffiles%2Fupload%2Froute.ts", "purpose": "POST → presigned PUT URL + r2Key", "lastChecked": "2025-09-27" },
      { "path": "app/api/files/[key]/route.ts", "exists": false, "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/app/api/files/%5Bkey%5D/route.ts", "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=app%2Fapi%2Ffiles%2F%5Bkey%5D%2Froute.ts", "purpose": "GET → authorized stream from R2", "lastChecked": "2025-09-27" },
      { "path": "lib/r2-signer.ts", "exists": false, "edit": "https://github.com/ComplianceLoop/complianceloop-site/edit/main/lib/r2-signer.ts", "create": "https://github.com/ComplianceLoop/complianceloop-site/new/main?filename=lib%2Fr2-signer.ts", "purpose": "AWS SigV4 presign (no deps)", "lastChecked": "2025-09-27" }
    ]
  },
  "operationalNotes": {
    "reconcilerProcess": {
      "summary": "Run the Reconciler once after edits. If the Playbook block is stuck or workflow says 'no changes to commit', reset playbook.md then run once.",
      "normalRun": {
        "commitTitle": "finances: add expenses + subscriptions and tallies; preserve phases",
        "steps": [
          "Open links.editDecisions",
          "Paste full-file decisions.json (phases + finances) and Commit changes with commitTitle",
          "Open links.runReconciler and Run workflow",
          "Open links.pulls, open the PR, Merge pull request, Confirm merge"
        ]
      },
      "resetRun": {
        "when": "Only if previous runs show no changes to commit or the Playbook block is stale.",
        "steps": [
          "Open links.editDecisions, paste full-file decisions.json, Commit changes",
          "Open links.editPlaybook, replace with '<!-- CL:START -->\\n<!-- CL:END -->', Commit changes with 'playbook: reset generated block'",
          "Open links.runReconciler and Run workflow",
          "Open links.pulls, open the PR, Merge pull request, Confirm merge"
        ]
      }
    },
    "r2Env": {
      "note": "Set env vars in Vercel; store no secrets in repo.",
      "vars": ["R2_ENDPOINT", "R2_REGION", "R2_ACCESS_KEY_ID", "R2_SECRET_ACCESS_KEY", "R2_BUCKET"]
    },
    "moduleResolution.playbook": [
      "Avoid imports like '@/app/../…'. Prefer '@/lib/…' and '@/db/…', or stable relative paths.",
      "When API routes under app/api/** error on imports, switch to **relative** imports targeting root shims (e.g., '../../../../lib/db').",
      "Root shims mapping to apps/portal code: lib/db.ts, db/schema.ts, lib/auth.ts."
    ],
    "tailwind.setup": [
      "Install tailwindcss, postcss, autoprefixer as **dependencies** in both root/package.json and apps/portal/package.json.",
      "apps/portal/postcss.config.js: { plugins: { tailwindcss: {}, autoprefixer: {} } }",
      "apps/portal/tailwind.config.ts content globs include portal and shared roots.",
      "apps/portal/styles/globals.css must start with Tailwind directives.",
      "apps/portal/app/layout.tsx must import '../styles/globals.css'."
    ],
    "designPlayground": [
      "Single source of truth at app/design-playground/page.tsx.",
      "Use **lowercase** component filenames and **relative** imports.",
      "Delete duplicate at apps/portal/app/design-playground/page.tsx and remove .github/workflows/design-skin-kit.yml."
    ],
    "vercel.deploy": [
      "When debugging builds, always redeploy with **Use existing Build Cache** unchecked.",
      "If 'Cannot find module tailwindcss', ensure Tailwind/PostCSS/Autoprefixer exist in dependencies at both root and apps/portal."
    ],
    "agentInstructionStyle": [
      "Always provide full-file replacements (no snippets).",
      "Precede steps with a matching **Edit** or **Create** link.",
      "Default to create links when a file might not exist; fall back to edit links if it does.",
      "Run the Reconciler once after both files are updated."
    ]
  },
  "checklists": {
    "prePhase3-ready": [
      "✅ Production deployment is green in Vercel (no-cache redeploy verified).",
      "✅ app/design-playground/page.tsx uses relative, lowercase imports.",
      "✅ Duplicate design-playground page removed under apps/portal/app/…",
      "✅ .github/workflows/design-skin-kit.yml removed.",
      "✅ Root shims exist: lib/db.ts, db/schema.ts, lib/auth.ts.",
      "✅ Tailwind configured: deps at root & apps/portal; postcss & tailwind config present; globals.css has directives; layout imports it.",
      "✅ Vercel env vars (R2) present."
    ]
  },
  "accomplishments": [
    "Resolved module resolution errors by replacing '@/app/../*' imports and adding root shims to apps/portal code.",
    "Normalized design playground imports; removed duplicate page and generator workflow.",
    "Installed and configured Tailwind for apps/portal; ensured production builds can resolve tailwindcss.",
    "Achieved successful production redeploy without cache."
  ],
  "status": { "playbookGeneratedAt": null, "lastReconciledAt": null },
  "handoff": {
    "purpose": "Allow any assistant/chat to resume seamlessly.",
    "repo": { "owner": "ComplianceLoop", "name": "complianceloop-site", "branch": "main" },
    "vercel": { "team": "ComplianceLoop", "project": "complianceloop-portal" },
    "expectations": [
      "Always fetch BOTH raw files before acting (decisions.json and playbook.md).",
      "Decisions live only in decisions.json; the Playbook CL block is generated.",
      "Never store secrets; refer by name (e.g., VERCEL_TOKEN, RESEND_API_KEY)."
    ],
    "successCriteria": [
      "Reconciler PR opens from the latest decisions.json.",
      "Playbook block regenerates to match decisions.json.",
      "No manual edits inside <!-- CL:START --> … <!-- CL:END -->."
    ],
    "safeRollback": [
      "Revert the last decisions.json commit on main.",
      "Reset playbook.md to only the CL block if needed and re-run the Reconciler."
    ]
  },
  "agentPromptTemplate": "You are the ComplianceLoop Playbook Agent. Implement the current phase using the fileActions list. Never write secrets to the repo. Use Vercel env for secrets (link provided). Avoid '@/app/../*' imports; prefer '@/lib/*' or stable relative paths. Ensure Tailwind is installed in both root and apps/portal package.json; apps/portal has postcss.config.js, tailwind.config.ts, and globals.css with Tailwind directives, imported from layout. Redeploy with cache disabled when debugging. Success: green build, /design-playground loads, auth routes compile, Tailwind styles present."
}
